<!DOCTYPE html>
<html lang="es-MX" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Sistema de inventario profesional para promotores de PepsiCo con modo offline">
  <meta name="author" content="José A. G. Betancourt">
  <meta name="theme-color" content="#004aad">
  <title>Águila Inventario Pro v7.0</title>

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Águila Pro">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-startup-image" href="icon-512x512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">

  <!-- Preconnect para Firebase (mejor performance) -->
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://firebasestorage.googleapis.com">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  
  <!-- Toast Container -->
  <div class="toast-container" role="alert" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal Escáner -->
  <div id="scanner-modal" class="hidden" role="dialog" aria-labelledby="scanner-title" aria-modal="true">
    <div id="scanner-view">
      <video id="interactive" aria-label="Vista de cámara para escaneo"></video>
    </div>
    <div id="scanner-status" role="status" aria-live="polite">Iniciando cámara...</div>
    <button id="close-scanner" class="error" aria-label="Cerrar escáner">Cerrar</button>
  </div>

  <!-- Sección de Autenticación -->
  <section id="auth-setup" class="card" style="max-width: 500px; margin: 50px auto;">
    <h2 style="text-align: center; color: var(--primary); margin-bottom: 24px;">
      Acceso Promotor Águila Pro
    </h2>

    <!-- Formulario Login -->
    <form id="login-form" aria-label="Formulario de inicio de sesión">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input 
          id="login-email" 
          type="email" 
          name="email"
          placeholder="tu.email@empresa.com" 
          autocomplete="email"
          required 
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="login-password">Contraseña</label>
        <input 
          id="login-password" 
          type="password" 
          name="password"
          placeholder="Mínimo 6 caracteres" 
          autocomplete="current-password"
          minlength="6"
          required 
          aria-required="true"
        />
      </div>
      <button type="button" id="btn-login" class="success">Iniciar Sesión</button>
      <p style="text-align: center; margin-top: 15px;">
        <a href="#" id="show-forgot-password" style="color: var(--warning);">
          ¿Olvidaste tu contraseña?
        </a>
      </p>
      <p style="text-align: center;">
        <a href="#" id="show-register" style="color: var(--primary);">
          ¿Eres nuevo? Regístrate aquí
        </a>
      </p>
    </form>

    <!-- Formulario Recuperar Contraseña -->
    <form id="forgot-password-form" class="hidden" aria-label="Recuperar contraseña">
      <h3 style="text-align: center; color: var(--primary);">Recuperar Contraseña</h3>
      <div class="form-group">
        <label for="forgot-email">Email</label>
        <input 
          id="forgot-email" 
          type="email" 
          name="email"
          placeholder="tu.email@empresa.com" 
          autocomplete="email"
          required 
          aria-required="true"
        />
      </div>
      <button type="submit" class="warning">Enviar Enlace</button>
      <p style="text-align: center; margin-top: 15px;">
        <a href="#" id="show-login-from-forgot" style="color: var(--primary);">
          Volver al inicio de sesión
        </a>
      </p>
    </form>

    <!-- Formulario Registro -->
    <form id="register-form" class="hidden" aria-label="Formulario de registro">
      <h3 style="text-align: center; color: var(--primary);">Registro Inicial</h3>
      <div class="form-group">
        <label for="register-email">Email</label>
        <input 
          id="register-email" 
          type="email" 
          name="email"
          placeholder="tu.email@empresa.com" 
          autocomplete="email"
          required 
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="register-password">Contraseña</label>
        <input 
          id="register-password" 
          type="password" 
          name="new-password"
          placeholder="Mínimo 6 caracteres" 
          autocomplete="new-password"
          minlength="6" 
          required 
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="register-determinante">Determinante (Tienda)</label>
        <input 
          id="register-determinante" 
          type="number" 
          placeholder="Ej: 12345" 
          required 
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="register-store-name">Nombre de la Tienda</label>
        <input 
          id="register-store-name" 
          type="text"
          name="organization"
          placeholder="Ej: Oxxo Centro" 
          autocomplete="organization"
          required 
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="register-promoter-name">Nombre del Promotor</label>
        <input 
          id="register-promoter-name" 
          type="text"
          name="name"
          placeholder="Ej: Juan Pérez" 
          autocomplete="name"
          required 
          aria-required="true"
        />
      </div>
      <button type="submit" class="success">Registrar y Entrar</button>
      <p style="text-align: center; margin-top: 15px;">
        <a href="#" id="show-login" style="color: var(--primary);">Ya tengo cuenta</a>
      </p>
    </form>
  </section>

  <!-- App Principal -->
  <main id="app-container" style="display: none;">
    
    <!-- Header -->
    <header class="app-header" role="banner">
      <h1>Águila Inventario Pro</h1>
      <div id="promoter-info-display">
        <span class="status-indicator status-online" role="status" aria-label="Estado de conexión"></span>
        <span id="connection-status-text">Conectado</span>
      </div>
    </header>

    <!-- Navegación por Tabs -->
    <nav class="tabs" role="tablist" aria-label="Navegación principal">
      <button data-tab="dashboard" class="active" role="tab" aria-selected="true" aria-controls="tab-dashboard">
        Resumen
      </button>
      <button data-tab="agregar-producto" role="tab" aria-selected="false" aria-controls="tab-agregar-producto">
        Agregar
      </button>
      <button data-tab="inventario" role="tab" aria-selected="false" aria-controls="tab-inventario">
        Inventario
      </button>
      <button data-tab="relleno" role="tab" aria-selected="false" aria-controls="tab-relleno">
        Relleno
      </button>
      <button data-tab="auditoria" role="tab" aria-selected="false" aria-controls="tab-auditoria">
        Auditar
      </button>
      <button data-tab="sistema" role="tab" aria-selected="false" aria-controls="tab-sistema">
        Sistema
      </button>
    </nav>

    <!-- Dashboard -->
    <section id="tab-dashboard" class="tab active" role="tabpanel" aria-labelledby="tab-dashboard">
      <div class="card">
        <h3 style="color: var(--primary);">Resumen General</h3>
        <div id="promoter-info-full">Cargando datos...</div>
      </div>
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-products" aria-label="Total de productos">0</div>
          <div class="stat-label">Productos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-inventory-value" aria-label="Total de cajas">0</div>
          <div class="stat-label">Total Cajas</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-movements" aria-label="Movimientos hoy">0</div>
          <div class="stat-label">Movimientos Hoy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="expiry-alert" aria-label="Productos por vencer">0</div>
          <div class="stat-label">Por Vencer</div>
        </div>
      </div>
    </section>

    <!-- Agregar Producto -->
    <section id="tab-agregar-producto" class="tab" role="tabpanel" aria-labelledby="tab-agregar-producto">
      <div class="card">
        <h3 style="color: var(--primary);">Agregar Producto</h3>
        <form id="add-product-form" aria-label="Formulario para agregar producto">
          <div class="form-row">
            <div class="form-group">
              <label for="add-barcode">Código de Barras *</label>
              <input id="add-barcode" type="text" placeholder="Escanear o escribir" required aria-required="true" />
            </div>
            <button type="button" id="add-scan-btn" class="success" style="width: auto; min-width: 140px;">
              Escanear
            </button>
          </div>
          <div class="form-group">
            <label for="add-product-name">Nombre del Producto *</label>
            <input id="add-product-name" type="text" placeholder="Ej: Papas Sabritas 50g" required aria-required="true" />
          </div>
          <div class="form-group">
            <label for="add-brand">Marca *</label>
            <select id="add-brand" required aria-required="true">
              <option value="">Seleccionar marca</option>
              <option value="Sabritas">Sabritas</option>
              <option value="Gamesa">Gamesa</option>
              <option value="Quaker">Quaker</option>
              <option value="Sonric's">Sonric's</option>
              <option value="Cacahuate">Cacahuate</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-pieces-per-box">Piezas por Caja *</label>
            <input id="add-pieces-per-box" type="number" placeholder="Ej: 24" min="1" required aria-required="true" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="add-warehouse">Ubicación (Almacén) *</label>
              <input id="add-warehouse" type="text" placeholder="Ej: Almacén 1" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="add-expiry-date">Fecha de Caducidad *</label>
              <input id="add-expiry-date" type="date" required aria-required="true" />
            </div>
          </div>
          <div class="form-group">
            <label for="add-boxes">Cajas a Agregar *</label>
            <input id="add-boxes" type="number" placeholder="Ej: 5" min="1" required aria-required="true" />
          </div>
          <button type="submit" class="success">Guardar Producto</button>
        </form>
      </div>
    </section>

    <!-- Inventario -->
<section id="tab-inventario" class="tab" role="tabpanel" aria-labelledby="tab-inventario">
  <div class="card">
    <h3 style="color: var(--primary);">Inventario Actual</h3>

    <!-- NUEVO: Botón Toggle Productos Sin Stock -->
    <button 
      id="toggle-stock-btn"
      data-stock-visible="false"
      style="
        width: 100%;
        padding: 14px;
        margin-bottom: 16px;
        background: var(--primary-light); /* Color más claro para que no compita con el botón principal */
        color: var(--primary-dark);
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      "
      onmouseover="this.style.background='var(--primary-hover)'"
      onmouseout="this.style.background='var(--primary-light)'"
    >
      <span id="toggle-icon">👁️‍🗨️</span> Mostrar Productos Sin Stock
    </button>
    
    <!-- Búsqueda con escáner -->
    <div class="search-container">
      <div class="form-row">
        <div class="form-group" style="flex: 2; margin: 0;">
          <label for="inventory-search" class="sr-only">Buscar en inventario</label>
          <input 
            type="text" 
            id="inventory-search" 
            placeholder="Buscar por nombre, marca o código..." 
            aria-label="Buscar en inventario"
            style="margin: 0;"
          />
        </div>
        <button type="button" id="inventory-scan-btn" class="success" style="width: auto; min-width: 140px; margin: 0;">
          📷 Escanear
        </button>
      </div>
    </div>
    
    <!-- Filtros de marca -->
    <div class="brand-filters-container">
      <h4 style="margin: 16px 0 8px 0; font-size: 14px; color: var(--muted);">Filtrar por marca:</h4>
      <div id="brand-filters" class="brand-filters">
        <!-- Los filtros se generan dinámicamente -->
      </div>
    </div>
    
    <!-- Lista de inventario -->
    <div id="inventory-list" role="region" aria-live="polite" aria-label="Lista de inventario">
      <p class="text-center text-muted">Cargando inventario...</p>
    </div>
  </div>
</section>

    <!-- Relleno -->
    <section id="tab-relleno" class="tab" role="tabpanel" aria-labelledby="tab-relleno">
      <div class="card">
        <h3 style="color: var(--primary);">Movimiento de Stock</h3>
        <p class="text-muted">Registra el movimiento de cajas del almacén al piso de venta.</p>
        <form id="refill-form" aria-label="Formulario de movimiento de stock">
          <div class="form-row">
            <div class="form-group">
              <label for="refill-barcode">Código de Barras *</label>
              <input id="refill-barcode" type="text" placeholder="Escanear o escribir" required aria-required="true" />
            </div>
            <button type="button" id="refill-scan-btn" class="success" style="width: auto; min-width: 140px;">
              Escanear
            </button>
          </div>
          <div id="refill-product-info" style="display: none; margin: 16px 0; padding: 16px; background: #f8fafc; border-radius: 8px;">
            <p id="refill-product-name" class="mb-0"><strong>Producto:</strong> N/A</p>
            <p id="refill-current-stock" class="mb-0 text-muted">Stock actual: N/A</p>
          </div>
          <div class="form-group">
            <label for="refill-boxes">Cajas a Mover *</label>
            <input id="refill-boxes" type="number" placeholder="Ej: 2" min="1" required aria-required="true" />
          </div>
          <button type="submit" class="warning">Registrar Movimiento</button>
        </form>
      </div>
    </section>

    <!-- Auditoría -->
    <section id="tab-auditoria" class="tab" role="tabpanel" aria-labelledby="tab-auditoria">
      <div class="card">
        <h3 style="color: var(--primary);">Auditoría Rápida</h3>
        <p class="text-muted">Escanea el código y registra la cantidad contada.</p>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning);">
          <h4 style="margin: 0 0 10px 0;">Bodega a Auditar</h4>
          <div class="form-row">
            <div class="form-group" style="flex: 2; margin: 0;">
              <label for="audit-warehouse" class="sr-only">Nombre de bodega</label>
              <input id="audit-warehouse" type="text" placeholder="Ej: Almacén 1" style="margin: 0;" />
            </div>
            <button type="button" id="save-warehouse-btn" class="warning" style="width: auto; min-width: 120px; margin: 0;">
              Confirmar
            </button>
          </div>
          <p id="current-warehouse-display" style="margin: 10px 0 0 0; font-size: 14px; color: var(--muted);" role="status">
            Sin bodega seleccionada
          </p>
        </div>
        
        <form id="audit-form" aria-label="Formulario de auditoría">
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label for="audit-barcode">Código de Barras *</label>
              <input id="audit-barcode" type="text" placeholder="Escanear código" required autofocus aria-required="true" />
            </div>
            <button type="button" id="audit-scan-btn" class="success" style="width: auto; min-width: 140px;">
              Escanear
            </button>
          </div>
          
          <div id="audit-product-info" style="display: none; margin: 16px 0; padding: 16px; background: #e6f7ff; border-radius: 8px; border-left: 4px solid var(--primary);">
            <p id="audit-product-name" class="mb-0"><strong>Producto:</strong> <span style="color: var(--primary);">N/A</span></p>
            <p id="audit-product-brand" class="mb-0 text-muted" style="margin-top: 4px;">Marca: N/A</p>
          </div>
          
          <div class="form-group">
            <label for="audit-boxes">Cantidad de Cajas Contadas *</label>
            <input 
              id="audit-boxes" 
              type="number" 
              placeholder="Ej: 10" 
              min="0" 
              required 
              aria-required="true"
              style="font-size: 24px; font-weight: 700; text-align: center; height: 60px;" 
            />
          </div>
          
          <button type="submit" class="success" style="font-size: 18px; padding: 18px;">
            Registrar Conteo
          </button>
        </form>
        
        <div class="card mt-2" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none;">
          <h4 style="color: white; margin: 0 0 10px 0;">Total Contado Hoy</h4>
          <div style="font-size: 3em; font-weight: 800;" id="audit-total-count" aria-label="Total de cajas contadas">0</div>
          <div style="font-size: 14px; opacity: 0.9;">cajas registradas</div>
        </div>
   
     <!-- Después del resumen de cajas -->
<div style="background: white; padding: 16px; border-radius: 12px; margin-top: 16px;">
  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
    <span style="color: #6b7280;">📊 Productos auditados:</span>
    <span id="audit-products-count" style="font-weight: 700; color: #004aad;">0</span>
  </div>
  <div style="display: flex; justify-content: space-between;">
    <span style="color: #6b7280;">📦 Total cajas:</span>
    <span id="audit-total-count" style="font-weight: 700; color: #004aad;">0</span>
  </div>
</div>

<!-- BOTÓN TERMINAR AUDITORÍA -->
<button 
  id="finish-audit-btn"
  style="
    width: 100%;
    margin-top: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    transition: all 0.3s ease;
    display: none;
  "
  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)';"
  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';"
>
  <div style="text-align: center;">
    <div style="font-size: 13px; opacity: 0.9;">
      📊 0 productos · 📦 0 cajas
    </div>
    <div style="font-size: 15px; font-weight: 700; margin-top: 4px;">
      🏁 Terminar Auditoría
    </div>
  </div>
</button>

        <div class="card mt-2" style="background: #f8fafc;">
          <h4 style="color: var(--secondary); margin: 0 0 15px 0;">Últimos Conteos</h4>
          <div id="audit-history" style="max-height: 200px; overflow-y: auto;" role="log" aria-live="polite">
            <p class="text-muted text-center">No hay conteos registrados hoy</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Sistema -->
    <section id="tab-sistema" class="tab" role="tabpanel" aria-labelledby="tab-sistema">
      <div class="card" style="border-left: 4px solid var(--primary);">
        <h3 style="color: var(--primary);">Estado del Sistema</h3>
        
        <div style="display: grid; gap: 10px; margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px;">
            <span style="font-weight: 600;">Conexión</span>
            <span id="system-connection-status" role="status">Verificando...</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px;">
            <span style="font-weight: 600;">Service Worker</span>
            <span id="system-sw-status">Deshabilitado</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px;">
            <span style="font-weight: 600;">Operaciones Pendientes</span>
            <span id="system-pending-ops" style="font-weight: 700; color: var(--success);">0</span>
          </div>
        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="diagnosticoFirebase()" class="secondary" style="flex: 1; min-width: 120px;">
            Diagnóstico
          </button>
          <button onclick="showSystemStats()" class="secondary" style="flex: 1; min-width: 120px;">
            Estadísticas
          </button>
          <button onclick="logout()" class="error" style="flex: 1; min-width: 120px;">
            Cerrar Sesión
          </button>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
          <h4 style="margin-top: 0;'>Zona de Peligro</h4>
          <button onclick="clearAllData()" class="error">Limpiar Datos Locales</button>
          <p class="text-muted" style="font-size: 12px; margin: 10px 0 0;">
            Esta acción eliminará los datos almacenados localmente.
          </p>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer style="background: var(--card-bg); padding: 20px; text-align: center; border-top: 2px solid var(--border); margin-top: 40px;" role="contentinfo">
    <p style="margin: 5px 0; font-weight: 600;">Águila Inventario Pro v7.0</p>
    <p style="margin: 5px 0; color: var(--muted); font-size: 14px;">&copy; 2025 José A. G. Betancourt</p>
    <p style="margin: 5px 0; color: var(--muted); font-size: 12px;">Sistema de Gestión de Inventario</p>
    <p style="margin: 5px 0; color: var(--muted); font-size: 11px;">Todos los derechos reservados</p>
  </footer>

  <!-- Scripts - ORDEN CRÍTICO CORREGIDO -->
  <!-- 1. Firebase SDKs - SIN defer para cargar inmediatamente -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <!-- 2. Quagga para escáner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  
  <!-- 3. Configuración Firebase - SIN defer, se ejecuta inmediatamente después de los SDKs -->
  <script src="firebase-config.js"></script>
  
  <!-- 4. Módulos de la aplicación - CON defer para no bloquear rendering -->
  <script src="auth.js"></script>
  <script src="ui.js"></script>
  <script src="inventory.js"></script>
  <script src="refill.js"></script>
  <script src="audit.js"></script>
  <script src="system.js"></script>
  <script src="app.js"></script>

</body>
</html>